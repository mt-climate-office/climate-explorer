---
format:
  pdf: 
    output-file: "qmd_output.pdf"
    geometry: 
      - top=20mm
      - bottom=20mm
      - left=20mm
      - right=20mm
params:
  scenarios: NA
  gridmet: NA
  cmip: NA
  location_id: NA
  location_name: NA
---

# Climate Report for `r params$location_name`
```{r setup, echo=FALSE}
source("./plot.R")
source("./global.R")

wrangle_historical <- function(id, name, element) {
  dat <- glue::glue(
    "http://blm_api/data/historical/{id}/{element}/"
  ) %>% 
    readr::read_csv(show_col_types = FALSE) 

  dat <- dat %>% 
    dplyr::mutate(date = lubridate::floor_date(date, "year")) %>%
    dplyr::group_by(date) %>% 
    dplyr::summarise(
      value = dplyr::if_else(
        dplyr::first(variable %in% c("pr", "pet", "etr")), 
        sum(value), 
        mean(value)
      ) 
    ) 
  
  
  dat %>% 
    ggplot(aes(x=date, y=value)) + 
    geom_point() + 
    geom_line() + 
    geom_smooth(method = "lm") + 
    theme_minimal() + 
    labs(
      x="Year", 
      y=legend_title(element),
      title = glue::glue("Trend in {name} Annual {legend_title(element)}")
    )
}

wrangle_future <- function(id, variable, type, scenarios) {
  
  scenarios = lapply(c("hist", scenarios), scenario_code_to_long)
  dat <- glue::glue(
    "http://blm_api/data/future/{id}/{variable}/?table_type={type}"
  ) %>%
    readr::read_csv(show_col_types = FALSE) %>% 
    dplyr::filter(scenario %in% scenarios) %>%
    factor_scenario() 
  
  if (type == "monthly") {
    plt <- dat %>% 
      dplyr::mutate(month = factor(month, levels = month.abb)) %>%
      make_monthly_plot(TRUE, FALSE) 
  } else {
    plt <- make_timeseries_plot(dat, TRUE, FALSE)
  }
  return(plt)
}

```
# Historical Trends
Climate has changed over the last 50 years in `r params$location_name`. Here are some figures to prove it...

``` {r historical_plots, echo=FALSE, warning=FALSE, message=FALSE}
#| label: fig-hist
#| fig-cap: !expr glue::glue("Historical climate trends in {params$location_name}")
#| fig.width: 9
#| fig.height: 14

purrr::map(params$gridmet, function(x) {
  wrangle_historical(params$location_id, params$location_name, x)  
}) %>% cowplot::plot_grid(plotlist=., nrow=length(params$gridmet))
```


# Climate Projections
It is projected that climate in `r params$location_name` will change considerably by the end of the century, depending on the emissions scenario.

## Timeseries of Projections
Here is a timeseries of how climate is projected to change by 2100:

``` {r future_timeseries, echo=FALSE, warning=FALSE, message=FALSE}
#| label: fig-timeseries
#| fig-cap: !expr glue::glue("Timeseries of projected changes in {params$location_name}")
#| fig.width: 9
#| fig.height: 14

purrr::map(params$cmip, function(x) {
  wrangle_future(params$location_id, x, "timeseries", params$scenarios)  
}) %>% cowplot::plot_grid(plotlist=., nrow=length(params$cmip))
```


## Monthly Climate Projections
There can be a large variability of how climate changes across the year. Below are plots of projected change in monthly conditions over the next century:

``` {r future_boxplot, echo=FALSE, warning=FALSE, message=FALSE}
#| label: fig-boxplot
#| fig-cap: !expr glue::glue("Projected changes in monthly climate in {params$location_name}")
#| fig.width: 9
#| fig.height: 14

purrr::map(params$cmip, function(x) {
  wrangle_future(params$location_id, x, "monthly", params$scenarios)  
}) %>% cowplot::plot_grid(plotlist=., nrow=length(params$cmip))
```
